from datetime import datetime

from config import Config

import disnake
from disnake.ext import commands
from Tools.exceptions import CustomError


class MarryButton(disnake.ui.View):

    def __init__(self, author, partner: disnake.Member):
        super().__init__()
        self.partner = partner
        self.author = author
        self.value = None
        self.config = Config()
    
    @disnake.ui.button(label="–ü—Ä–∏–Ω—è—Ç—å", style=disnake.ButtonStyle.green)
    async def marry_button_accept(self, button, inter):
        if inter.author.id != self.partner.id:
            await inter.response.send_message("–ü—Ä–∏–Ω—è—Ç—å –¥–æ–ª–∂–µ–Ω —Ç–æ—Ç, –∫–æ–≥–æ –ø–æ–ø—Ä–æ—Å–∏–ª–∏!", ephemeral=True)
        else:
            await inter.response.send_message(f'{inter.author.mention} –°–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) –±—ã—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º üéâ')
            await self.config.DB.marries.insert_one({"_id": self.author.id, "mate": self.partner.id, 'time': datetime.now()})
            self.stop()

    @disnake.ui.button(label="–û—Ç–∫–∞–∑–∞—Ç—å", style=disnake.ButtonStyle.red)
    async def marry_button_cancel(self, button, inter):
        if inter.author.id != self.partner.id:
            await inter.response.send_message("–ù–∞–∂–∞—Ç—å –¥–æ–ª–∂–µ–Ω(–Ω–∞) —Ç–æ—Ç, –∫–æ–≥–æ –ø–æ–ø—Ä–æ—Å–∏–ª–∏!", ephemeral=True)
        else:
            await inter.response.send_message(f'{inter.author.id} –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) –±—ã—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º')
            self.stop()


class DivorceButton(disnake.ui.View):

    def __init__(self, partner: disnake.Member):
        super().__init__()
        self.partner = partner
        self.value = None
        self.config = Config()
    
    @disnake.ui.button(label="–†–∞–∑–æ—Ä–≤–∞—Ç—å –±—Ä–∞–∫", style=disnake.ButtonStyle.red)
    async def divorce_button_accept(self, button, inter):
        if inter.author.id != self.partner.id:
            await inter.response.send_message("–ù–∞–∂–∞—Ç—å –¥–æ–ª–∂–µ–Ω(–∞) —Ç–æ—Ç(–∞), —Å –∫–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—É–∂–µ–º!", ephemeral=True)
        else:
            await inter.response.send_message(f'{self.partner.mention} –°–æ–≥–ª–∞—Å–∏–ª—Å—è(–∞—Å—å) —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –±—Ä–∞–∫(. –£–¥–∞—á–∏.')
            await self.config.DB.marries.delete_one({"$or": [{"_id": inter.author.id}, {"mate": self.partner.id}]})
            self.stop()


class Marries(commands.Cog, name="—Å–≤–∞–¥—å–±—ã", description="–ú–æ–∂–Ω–æ –ø–æ–∂–µ–Ω–∏—Ç—å—Å—è —Å –∫–µ–º-–Ω–∏–±—É–¥—å, —Ö–∏—Ö–∏"):

    COG_EMOJI = "üíç"

    async def is_married(self, author: disnake.Member, bot):
        return await bot.config.DB.marries.count_documents({'$or': [{'_id': author.id}, {'mate': author.id}]})

    @commands.slash_command(name='marry', description="–°–≤–∞–¥—å–±—ã")
    async def marry_cmd(self, inter):
        ...

    @marry_cmd.sub_command(name="invite", description="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—ã–≥—Ä–∞—Ç—å —Å–≤–∞–¥—å–±—É –∫–æ–º—É-–ª–∏–±–æ")
    async def marry_invite(self, inter, member: disnake.Member):
        member_married = await self.is_married(member, inter.bot)
        author_married = await self.is_married(inter.author, inter.bot)

        if inter.author.id == member.id:
            raise CustomError("–í—ã–π—Ç–∏ –∑–∞–º—É–∂ –∑–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è..?")
        elif member_married:
            raise CustomError(f"–≠–º) {member.mention} –≤ –±—Ä–∞–∫–µ. –ù–∞ —á—Ç–æ –≤—ã –Ω–∞–¥–µ–µ—Ç–µ—Å—å?")
        elif author_married:
            partner = await inter.bot.fetch_user((await inter.bot.config.DB.marries.find_one({'_id': inter.author.id}))['mate'])
            raise CustomError(f"–≠–º) –í—ã —É–∂–µ –≤ –±—Ä–∞–∫–µ —Å {partner.mention}. –ù–∞ —á—Ç–æ –≤—ã –Ω–∞–¥–µ–µ—Ç–µ—Å—å?")
        
        await inter.send(
            embed=await inter.bot.embeds.simple(
                title="–°–≤–∞–¥—å–±–∞, –ø–æ–ª—É—á–∞–µ—Ç—Å—è <3", 
                description=f"{inter.author.mention} –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç {member.mention} —Å—ã–≥—Ä–∞—Ç—å —Å–≤–∞–¥—å–±—É. –ú–º–º...)",
                footer={"text": "–¢–æ–ª—å–∫–æ, –¥–∞–≤–∞–π—Ç–µ, –±–µ–∑ –±–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ 16, —Ö–æ—Ä–æ—à–æ?", 'icon_url': inter.author.display_avatar.url}
            ), view=MarryButton(author=inter.author, partner=member)
        )

    @marry_cmd.sub_command(name='divorce', description="–†–∞–∑–≤–æ–¥ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º")
    async def marry_divorce(self, inter):
        if await self.is_married(inter.author, inter.bot) > 0:
            await inter.send(
                embed=await inter.bot.embeds.simple(
                    title='–í—ã —É–≤–µ—Ä–µ–Ω—ã? :(', 
                    description=f"{inter.author.mention} –≤–¥—Ä—É–≥ –∑–∞—Ö–æ—Ç–µ–ª(-–∞) –ø–æ—Ä–≤–∞—Ç—å –±—Ä–∞—á–Ω—ã–µ —É–∑—ã."),
                view=DivorceButton(partner=inter.bot.get_user(dict(await inter.bot.config.DB.marries.find_one({'mate': inter.author.id}))['_id']) if await inter.bot.config.DB.marries.count_documents({"mate": inter.author.id}) != 0 else inter.bot.get_user(dict(await inter.bot.config.DB.marries.find_one({'_id': inter.author.id}))['mate']))
            )
        else:
            raise CustomError("–í—ã –∏ —Ç–∞–∫ –Ω–µ –≤ –±—Ä–∞–∫–µ, —Ö–∏—Ö–∏.")

    @marry_cmd.sub_command(name="marries", description="–í—ã–≤–æ–¥–∏—Ç –±—Ä–∞–∫–∏")
    async def marry_marries(self, inter):
        data = [
            f"`{inter.guild.get_member(i['_id']).name}` + `{inter.guild.get_member(i['mate']).name}` | <t:{round(i['time'].timestamp())}:D>"
            async for i in inter.bot.config.DB.marries.find()
            if i['_id'] in [i.id for i in inter.guild.members] and i['mate'] in [i.id for i in inter.guild.members]
        ]
        await inter.send(
            embed=await inter.bot.embeds.simple(
                title='–ü–∞—Ä–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å —Ç—É—Ç–∞', 
                description='\n'.join(data) if len(data) != 0 else "–ù–µ—Ç –ø–∞—Ä–æ—á–µ–∫, –ø–æ–ª—É—á–∞–µ—Ç—Å—è."
            )
        )


def setup(bot):
    bot.add_cog(Marries(bot))
